<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" 
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="PWAimage/slime192.png">
  <title>PWA</title>
  <style>
    /* 全体の基本設定 */
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      background-color: #111;
      font-family: sans-serif;
    }
    /* 下部領域（例としてのゲームエリア） */
    .bottom-screen {
      position: relative;
      background-color: #000;
      overflow: hidden;
      height: 100vh;
    }
    /* 判定ライン */
    .judgeline {
      position: absolute;
      width: 2vw;
      height: 100%;
      background-color: rgb(0, 255, 115);
      left: 20%;
      top: 0;
    }
    /* ノーツとなる円 */
    .circle {
      position: absolute;
      top: 40%;
      width: 16vh;
      height: 16vh;
      background-color: white;
      border-radius: 50%;
      will-change: transform;
    }
    /* PiPボタン（画面右上に固定） */
    #pipButton {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- ゲームエリアなど、既存のコンテンツ -->
  <div class="bottom-screen" id="game-area">
    <div class="judgeline" id="judgeline"></div>
  </div>
  
  <!-- 音声用オーディオ要素 -->
  <audio id="hit-sound" src="A.mp3"></audio>
  
  <!-- Picture-in-Picture 起動用ボタン -->
  <button id="pipButton">Picture in Picture</button>
  
  <script>
    /* 既存のノーツ生成／アニメーション処理はそのまま */
    const hitSound = document.getElementById('hit-sound');
    
    function startGame() {
      const gameArea = document.getElementById("game-area");
      const judgementLine = document.getElementById("judgeline");
      const gameAreaWidth = gameArea.offsetWidth;
      
      function createCircle() {
        const circle = document.createElement("div");
        circle.classList.add("circle");
        circle.played = false;
        let circleX = gameAreaWidth;
        circle.style.left = circleX + "px";
        gameArea.appendChild(circle);
        
        function animate() {
          circleX -= 5; // px/フレーム
          circle.style.left = circleX + "px";
          
          const circleRect = circle.getBoundingClientRect();
          const judgementRect = judgementLine.getBoundingClientRect();
          const center = circleRect.left + circleRect.width / 2;
          const judgeX = judgementRect.left;
          
          if (!circle.played && center - judgeX < 0) {
            hitSound.currentTime = 0;
            hitSound.play().catch(error => console.error('音声再生エラー:', error));
            circle.played = true;
            circle.remove();
            return;
          }
          
          if (circleX + circleRect.width > 0) {
            requestAnimationFrame(animate);
          } else {
            circle.remove();
          }
        }
        
        requestAnimationFrame(animate);
      }
      
      setInterval(createCircle, 1000);
    }
    
    window.onload = function() {
      startGame();
    };

    /* Document Picture-in-Picture の実装 */
    // 注：現時点でこの API は実験的です。実施環境で有効か確認してください。
    if (document.documentElement.requestPictureInPicture) {
      document.getElementById('pipButton').addEventListener('click', async function() {
        try {
          // preferredAspectRatio を 3.0 と指定（横長：3:1の比率）
          await document.documentElement.requestPictureInPicture({ preferredAspectRatio: 3.0 });
          console.log('Picture-in-Picture モードに入りました');
        } catch (error) {
          console.error('Picture-in-Picture に入る際にエラーが発生しました:', error);
        }
      });
    } else {
      console.error('このブラウザでは Document Picture-in-Picture はサポートされていません。');
      // 必要ならボタンを非表示にする
      document.getElementById('pipButton').style.display = 'none';
    }
  </script>
</body>
</html>
